<header *ngIf="prestacion">
    <header-paciente *ngIf="paciente" [paciente]="paciente"></header-paciente>
</header>
<section *ngIf="!showDarTurnos && prestacion && paciente">
    <plex-box>
        <header>
            <div class="clearfix">
                <div *ngIf="prestacion?.solicitud">
                    <div class="page-title">Resumen
                        <b>{{prestacion.solicitud.tipoPrestacion.term}}</b>
                    </div>
                </div>
            </div>
        </header>
        <div class="row">
            <div class="col-9">
                <ng-container *ngFor="let elemento of prestacion.ejecucion.registros; let i = index">
                    <div class="rup-card">
                        <div class="type {{ elemento.esSolicitud ? 'planes' : elemento.concepto.semanticTag }}">
                        </div>
                        <div class="rup-content">
                            <div class="rup-body">
                                <div class="row">
                                    <div class="col-3">
                                        <b *ngIf="elemento?.nombre">
                                            {{elemento.nombre[0].toUpperCase() + elemento.nombre.slice(1)}}
                                        </b>
                                        <br>
                                        <small class="text-secondary" *ngIf="elemento?.valor?.evolucion">{{ elemento?.valor?.evolucion | slice:0:40 }}...</small>
                                    </div>
                                    <div class="col-8">
                                        <rup [paciente]="paciente" [elementoRUP]="elementosRUPService.buscarElemento(elemento.concepto, elemento.esSolicitud)" [prestacion]="prestacion"
                                            [registro]="elemento" [soloValores]="true">
                                        </rup>
                                        <ng-container *ngIf="(elemento.concepto.semanticTag === 'hallazgo' || elemento.concepto.semanticTag ==='situación' || elemento.concepto.semanticTag === 'trastorno')">
                                            <small class="badge badge-info" *ngIf="prestacion.estados[prestacion.estados.length - 1].tipo === 'validada' && elemento.esDiagnosticoPrincipal">
                                                Diagnóstico principal
                                            </small>
                                            <!-- title="Diagnóstico principal" titlePosition="right" -->
                                            <ng-container *ngIf="prestacion.estados[prestacion.estados.length - 1].tipo !== 'validada'">
                                                <!-- <plex-bool class="text-sm"  [readonly]="false" [(ngModel)]="elemento.esDiagnosticoPrincipal"
                                                    type="slide" name="Diagnóstico principal"></plex-bool> -->
                                                <div (click)="diagnosticoPrestacion(elemento)" class="hover text-info mdi mdi-36px" [ngClass]="{
                                                        'mdi-toggle-switch': elemento.esDiagnosticoPrincipal,
                                                        'mdi-toggle-switch-off': !elemento.esDiagnosticoPrincipal
                                                    }"></div>
                                                <small>Diagnóstico principal</small>
                                            </ng-container>

                                            <!--  title="Es primera vez" titlePosition="right" -->
                                            <ng-container *ngIf="codigosCie10 && codigosCie10[elemento.id] && codigosCie10[elemento.id].c2">
                                                <plex-bool class="text-sm" [(ngModel)]="elemento.esPrimeraVez" type="slide" name="primeraVez">
                                                </plex-bool>
                                                <small>Es primera vez</small>
                                            </ng-container>
                                        </ng-container>
                                    </div>
                                    <div class="col-1 m-0 p-0 text-center">
                                        <div class="text-info hover mdi mdi-24px mdi-arrow-{{ elemento.icon || 'left' }}-drop-circle-outline" (click)="elemento.icon = elemento.icon === 'down' ? 'left' : 'down'"></div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12" *ngIf="elemento.icon === 'down'">
                                        <div *ngIf="elemento?.valor?.evolucion" class="text-secondary">
                                            <b>Evolución: </b>{{ elemento.valor.evolucion }}
                                        </div>
                                        <div *ngIf="elemento?.valor?.motivo" class="text-secondary">
                                            <b>Motivo:</b> {{ elemento.valor.motivo || '(no definido)' }}
                                        </div>
                                        <div *ngIf="elemento?.valor?.indicaciones" class="text-secondary">
                                            <b>Indicaciones: </b> {{ elemento.valor.indicaciones || '(ninguna)' }}
                                        </div>
                                        <div *ngIf="elemento?.relacionadoCon && elemento?.relacionadoCon.length > 0">
                                            <b>Relacionado con:</b> {{ elemento.relacionadoCon[0].concepto.term[0].toUpperCase()
                                            + elemento.relacionadoCon[0].concepto.term.slice(1)}}
                                        </div>
                                        <div *ngIf="elemento?.evoluciones" class="text-secondary">Inicio aproximado:
                                            <ng-container *ngIf="!elemento?.evoluciones">{{ elemento.valor.fechaInicio | fromNow }}</ng-container>
                                            <ng-container *ngIf="elemento?.evoluciones">{{ elemento.evoluciones[0].fechaInicio | fromNow }}</ng-container>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- <div class="rup-footer">
                                <div class="row" *ngIf="(elemento.concepto.semanticTag === 'hallazgo' || elemento.concepto.semanticTag ==='situación' || elemento.concepto.semanticTag === 'trastorno')">
                                    <div class="col-6">
                                        <div *ngIf="!diagnosticoReadonly">
                                            <plex-bool [readonly]="diagnosticoReadonly" [(ngModel)]="elemento.esDiagnosticoPrincipal" type="slide" label="Diagnostico principal"
                                                name="Diagnóstico principal" (click)="diagnosticoPrestacion(i)"></plex-bool>
                                        </div>
                                    </div>
                                    <div class="col-6" *ngIf="codigosCie10 && codigosCie10[elemento.id]">
                                        <plex-bool *ngIf="codigosCie10[elemento.id].c2" [(ngModel)]="elemento.esPrimeraVez" type="slide" label="Es primera vez" name="primeraVez"></plex-bool>
                                    </div>
                                </div>
                            </div> -->
                        </div>
                    </div>
                </ng-container>
            </div>
            <div class="col-3">
                <!-- ÁRBOL -->
                <ng-container *ngFor="let rama of prestacion.ejecucion.registros; let iRama = index">
                    <ul class="list-group">
                        <li class="list-group-item pl-0 pt-0 pb-0 mb-0">
                            <div>
                                <span class="type {{ rama.esSolicitud ? 'planes' : rama.concepto.semanticTag }} pr-2 mr-1"></span>
                                <span>{{ rama.nombre }}</span>
                            </div>
                            <!-- <rup [paciente]="paciente" [elementoRUP]="elementosRUPService.buscarElemento(rama.concepto, rama.esSolicitud)" [prestacion]="prestacion"
                                [registro]="rama" [soloValores]="true" [params]="{arbol: true}">
                            </rup> -->
                        </li>
                    </ul>
                </ng-container>
            </div>
        </div>
    </plex-box>
</section>
<footer *ngIf="!showDarTurnos">
    <div class="row">
        <div class="col-3">
            <plex-button *ngIf="prestacion && prestacion.estados && prestacion.estados[prestacion.estados.length-1].tipo === 'ejecucion'"
                label="Continuar {{prestacion.solicitud.tipoPrestacion.term}}" (click)="volver()" type="info"></plex-button>

            <plex-button *ngIf="prestacion && prestacion.estados && prestacion.estados[prestacion.estados.length-1].tipo === 'validada'"
                label="Punto de Inicio" (click)="volverInicio()" type="info"></plex-button>
        </div>
        <div class=" col-6 text-center">
        </div>
        <div class="col text-right ">

            <plex-button *ngIf="prestacion && prestacion.estados && prestacion.estados[prestacion.estados.length-1].tipo !== 'validada'"
                label="Validar {{prestacion.solicitud.tipoPrestacion.term}}" (click)="validar()" type="success"></plex-button>

            <plex-button label="Romper Validación de {{prestacion?.solicitud?.tipoPrestacion?.term}}" (click)="romperValidacion()" type="warning"
                *ngIf="prestacion && prestacion.estados
                && prestacion.estados[prestacion.estados.length-1].tipo === 'validada'
                && prestacion.estados[prestacion.estados.length-1].createdBy.username === auth.usuario.username">
            </plex-button>
        </div>
    </div>
</footer>

<!-- Calendario para dar turnos autocitados -->
<!-- <pre> {{solicitudTurno | json}}</pre> -->
<dar-turnos *ngIf="showDarTurnos && solicitudTurno" (cancelarDarTurno)="turnoDado($event)" [pacienteSeleccionado]="paciente"
    [solicitudPrestacion]="solicitudTurno" (cancelarDarTurno)="showDarTurnos = false"></dar-turnos>

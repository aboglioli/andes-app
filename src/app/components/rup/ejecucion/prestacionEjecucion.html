<style>
    .msg-problema {
        border: 1px solid #ff9900;
        color: #ff9900;
        margin-bottom: 10px;
        padding: 10px;
    }
    
    small {
        color: grey;
        font-weight: 400;
        font-size: 0.85rem;
    }
    
    .linea-sup {
        border-top: 1px solid #ccc;
    }
    
    .gris {
        color: #999999;
    }
    
    .msg-problema i {
        color: #ff9900;
    }
    
    h5.box-title-principal {
        color: #00A8E0;
        font-weight: 350;
        padding-bottom: 5px;
    }
    
    h5.box-title-secundario {
        color: #00A8E0;
        font-weight: 350;
        padding-bottom: 5px;
        border-bottom: solid black 1px;
    }
    
    .btn-contextual {
        font-size: 1.5em;
        color: #AAAAAA;
        background-color: white;
        border-color: none;
        box-shadow: none;
        border: none;
    }
    
    .list-inline>.list-inline-item {
        margin-bottom: 10px;
    }
    
    .list-group>.list-group-item {
        border-color: #AAAAAA;
        border-radius: 0px;
    }
    
    .list-group-item:hover {
        background-color: #f9f9f9;
        border: solid 1px #00A8E0;
    }
    
    .list-group-item:active {
        background-color: #f5f5f5;
        border: solid 1px #AAAAAA;
    }
    /*Etiquetas*/
    
    .badge {
        text-transform: uppercase;
        font-size: 0.75rem;
        font-weight: 500;
        margin: 0px 10px 10px 0px;
        display: inline-block;
    }
    
    .badge-danger {
        border: 1.5px solid #dd4b39;
        border-radius: 0px;
        background: transparent;
        color: #dd4b39;
    }
    
    .badge-success {
        border: 1.5px solid #8CC63F;
        border-radius: 0px;
        background: transparent;
        color: #8CC63F;
    }
    
    .badge-warning {
        border: 1.5px solid #ff8d22;
        border-radius: 0px;
        background: transparent;
        color: #ff8d22;
    }
    
    .badge-info {
        border: 1.5px solid #00A8E0;
        border-radius: 0px;
        background: transparent;
        color: #00A8E0;
    }
</style>

<header *ngIf="prestacion">
    <header-paciente [paciente]="prestacion.paciente" [prestacion]="prestacion"></header-paciente>
    <!--<br/>
    <div class="row">
        <div class="col-12">
            <h5 class="box-title-secundario">{{prestacion.solicitud.tipoPrestacion.nombre}}</h5>
        </div>
    </div>-->
</header>


<section>
    <div class="row">

        <!--LISTA DE PROBLEMAS ACTIVOS-->
        <div class="col-2">
            <plex-box>
                <header>
                    <div class="row">
                        <div class="col">
                            <h5 class="box-title-principal">Lista de Problemas Activos</h5>
                        </div>
                    </div>
                </header>

                <ul class="list-group">
                    <ng-container *ngFor="let problema of listaProblemas">
                        <li class="list-group-item" *ngIf="problema.evoluciones && problema.evoluciones.length > 0 && problema.evoluciones[problema.evoluciones.length - 1].vigencia == 'activo'">
                            <div>
                                <span class="badge badge-success">Activo</span>
                                <br /> {{problema.tipoProblema.nombre}}
                                <br />
                                <small>
                                    Inicio: {{problema.fechaInicio | date: 'dd/MM/yyyy'}}
                                </small>
                            </div>
                        </li>
                    </ng-container>
                </ul>
            </plex-box>
        </div>

        <!--LISTA DE PROBLEMAS TRATADOS EN ESTA CONSULTA-->
        <div class="col-5">
            <plex-box>
                <header>
                    <div class="row">
                        <div class="col">
                            <h5 class="box-title-principal">Problemas tratados en esta consulta</h5>
                        </div>
                    </div>
                </header>

                <div class="row" *ngIf="!showEvolucionar && !showEvolTodo && !showTransformar && !showEnmendar && !showDetalles">
                    <div class="col-8">
                        <plex-select [(ngModel)]="tipoProblema" (getData)="loadTiposProblemas($event)" placeholder="Agregar Problema">
                        </plex-select>
                    </div>
                    <div class="col-1">
                        <plex-button title="Cargar Problema" icon="mdi mdi-plus" (click)="agregarProblema()" type="success"></plex-button>
                    </div>
                    <div class="col text-right">
                        <plex-button title="Evolucionar los Problemas" label="Evolucionar Todos " (click)="evolucionarTodo()" type="primary"></plex-button>
                    </div>
                </div>

                <div *ngIf="prestacion && prestacion.solicitud && prestacion.ejecucion.listaProblemas">
                    <div *ngFor="let problema of prestacion.ejecucion.listaProblemas">
                        <ul class="list-group" *ngIf="problema.evoluciones && problema.evoluciones.length > 0">
                            <li class="list-group-item">
                                <div class="col-11">
                                    <span class=" badge badge-success" *ngIf="problema.evoluciones[problema.evoluciones.length - 1].vigencia == 'activo'">
                                                    Activo
                                                </span>
                                    <span class="badge badge-danger" *ngIf="problema.evoluciones[problema.evoluciones.length - 1].vigencia != 'activo'">
                                                    {{problema.evoluciones[problema.evoluciones.length - 1].vigencia}}
                                                </span>
                                    <span class="badge badge-warning" *ngIf="problema.evoluciones[problema.evoluciones.length - 1].vigencia != 'Resuelto'">
                                                    {{problema.evoluciones[problema.evoluciones.length - 1].duracion}} 
                                                </span>
                                    <br>
                                    <span>
                                                    <h5 class="item-title">{{problema.tipoProblema.nombre}}</h5>
                                                </span>

                                    <br>

                                    <span class="" *ngIf="problema.evoluciones && problema.evoluciones.length > 0">                                                                                                
                                        <strong> Última evolución: </strong> 
                                        <small>
                                            {{problema.evoluciones[problema.evoluciones.length - 1].observacion}} |
                                            {{problema.evoluciones[problema.evoluciones.length - 1].fecha | date: 'dd/MM/yyyy'}} 
                                        </small>                                       
                                    </span>
                                </div>
                                <div class="col-1">
                                    <span class="pull-right">
                                        <plex-dropdown [right]="true" icon="dots-vertical" (click)="mostrarOpciones(problema)" [items]="items"></plex-dropdown>
                                    </span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <br/>
                        <div *ngIf="showEvolucionar && !showEvolTodo">
                            <rup-evolucionaProblema [problema]="problemaTratar" (evtData)="onReturn($event)"></rup-evolucionaProblema>
                        </div>
                        <br/>
                        <div *ngIf="showTransformar">
                            <rup-transformarProblema [problema]="problemaTratar" [listaProblemas]="listaProblemas" [paciente]="prestacion.paciente" (evtData)="onReturnTransformar($event)"></rup-transformarProblema>
                        </div>
                        <br/>
                        <div *ngIf="showEnmendar">
                            <rup-enmendarProblema [problema]="problemaTratar" (evtData)="onReturnEnmendar($event)"></rup-enmendarProblema>
                        </div>
                        <br/>
                        <div *ngIf="showDetalles">
                            <rup-verProblemaPaciente [problema]="problemaTratar" (evtData)="onReturn($event)"></rup-verProblemaPaciente>
                        </div>
                    </div>
                </div>

                <div *ngIf="!showEvolucionar && showEvolTodo">
                    <rup-evolucionaProblemasTodos [problemas]="listaProblemas" (evtData)="onReturnTodos($event)"></rup-evolucionaProblemasTodos>
                </div>
            </plex-box>
        </div>

        <!--LISTA DE PRESTACIONES-->
        <div class="col-5">
            <plex-box *ngIf=" prestacion && prestacion.paciente">
                <header>
                    <div class="row">
                        <div class="col">
                            <h5 class="box-title-principal">Lista de Prestaciones</h5>
                        </div>
                    </div>
                </header>

                <fieldset>
                    <div class="row">
                        <div class="col-10">
                            <plex-select [(ngModel)]="prestacionAEjecutar" name="ejecutarPrestacion" label="" (getData)="$event.callback(tiposPrestacionesPosibles)" placeholder="Seleccione prestación">
                            </plex-select>
                        </div>
                        <div class="col-2">
                            <plex-button title="Agregar" label="Agregar" type="success" (click)="agregarPrestacionEjecucion(prestacionAEjecutar)" class="pull-right"></plex-button>
                        </div>
                    </div>
                </fieldset>


                <fieldset>
                    <!-- nuevas prestaciones ejecutadas en la consulta -->
                    <plex-accordion *ngIf="prestacionesEjecucion">
                        <div *ngFor="let _prestacion of prestacionesEjecucion">

                            <plex-panel tituloPrincipal="{{_prestacion.solicitud.tipoPrestacion.nombre}}">
                                <rup #rup [valoresPrestacionEjecucion]="data" [prestacion]="prestacion" [prestacionesEjecucion]="prestacionesEjecucion" [tipoPrestacion]="_prestacion.solicitud.tipoPrestacion" [paciente]="_prestacion.paciente" (evtData)="onReturnComponent($event, _prestacion.solicitud.tipoPrestacion)"
                                    [datosIngreso]="(_prestacion.ejecucion.evoluciones && _prestacion.ejecucion.evoluciones[_prestacion.ejecucion.evoluciones.length-1] && _prestacion.ejecucion.evoluciones[_prestacion.ejecucion.evoluciones.length-1].valores) ? _prestacion.ejecucion.evoluciones[_prestacion.ejecucion.evoluciones.length-1].valores[_prestacion.solicitud.tipoPrestacion.key] : null">
                                </rup>

                                <div class="row">
                                    <div class="col-12">
                                        <plex-select [(ngModel)]="listaProblemaPrestacion[_prestacion.solicitud.tipoPrestacion.key]" name="tallaListaProblemas" label="Vincular a problemas" labelField="tipoProblema.nombre" [data]="listaProblemas" [multiple]="true" placeholder="Seleccione problema(s)">
                                        </plex-select>
                                    </div>
                                </div>
                            </plex-panel>

                        </div>
                    </plex-accordion>
                    <!--nuevas prestaciones ejecutadas en la consulta -->
                </fieldset>

                <br />

                <fieldset>
                    <h5 class="box-title-secundario">Lista de Planes</h5>
                    <div class="row">
                        <div class="col-5">
                            <plex-select [(ngModel)]="nuevoTipoPrestacion" name="nuevaPrestacion" (getData)="buscarTipoPrestacion($event)" placeholder="Seleccione prestación"></plex-select>
                        </div>
                        <div class="col-5">
                            <plex-select [(ngModel)]="listaProblemasPlan" name="nuevaPrestacionProblemas" (getData)="$event.callback(listaProblemas)" labelField="tipoProblema.nombre" [multiple]="true" placeholder="Seleccione problema(s)"></plex-select>
                        </div>
                        <div class="col-2">
                            <plex-button title="Agregar al plan" label="" icon="mdi mdi-plus" type="primary " (click)="agregarPrestacionFutura()"></plex-button>
                        </div>
                    </div>

                    <div *ngFor="let prestacionFutura of prestacion.prestacionesSolicitadas; let i = index;" style="padding: 10px; border: 1px solid #999; margin-bottom: 20px;">
                        <div class="row" style="margin-bottom: 20px;" *ngIf="prestacionFutura.solicitud">
                            <div class="col-10">
                                <p>
                                    {{prestacionFutura.solicitud.tipoPrestacion.nombre}}
                                </p>
                            </div>
                            <div class="col-2 text-right">
                                <plex-button title="Eliminar " label=" " icon="close " type="danger " (click)="borrarPrestacionFutura(i)"></plex-button>
                            </div>
                        </div>
                        <div *ngIf="prestacionFutura && prestacionFutura.solicitud && prestacionFutura.solicitud.listaProblemas && prestacionFutura.solicitud.listaProblemas.length">
                            <div *ngFor="let problema of prestacionFutura.solicitud.listaProblemas">
                                <div class="row ">
                                    <div class="col-12">
                                        <div class="msg-problema">
                                            <i class="mdi mdi-link"> </i> Prestacion asignada a <b>{{problema.tipoProblema.nombre}}</b>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>

            </plex-box>
        </div>

    </div>
</section>

<footer>
    <div class="row">
        <div class="col-3">
            <plex-button title="Volver" icon="mdi mdi-arrow-left-bold" label="volver" (click)="volver('rup/resumen')" type="danger"></plex-button>
        </div>
        <div class=" col-6 text-center">
            <div *ngIf="error !=0 " class="alert alert-danger " role="alert">
                {{error}}
            </div>
        </div>
        <div class="col-3 text-right ">
            <plex-button title="Guardar " label="GUARDAR " (click)="evolucionarPrestacion('rup/validacion')" type="success"></plex-button>
        </div>
    </div>
</footer>
